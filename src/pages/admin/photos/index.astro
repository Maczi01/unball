---
import Layout from "@/layouts/Layout.astro";
import { PhotosListWithBulkActions } from "@/components/PhotosListWithBulkActions";
import type { AdminPhotosResponseDTO } from "@/types";

export const prerender = false;

// Check authentication
const { user } = Astro.locals;

if (!user) {
  return Astro.redirect("/login?redirect=/admin/photos");
}

// Check admin role
const { data: userData, error: userError } = await Astro.locals.supabase
  .from("users")
  .select("role")
  .eq("id", user.id)
  .single();

if (userError || !userData || userData.role !== "admin") {
  return Astro.redirect("/?error=unauthorized");
}

// Fetch photos
let photosData: AdminPhotosResponseDTO | null = null;

try {
  const response = await fetch(
    `${Astro.url.origin}/api/admin/photos?page=1&limit=50`,
    {
      headers: {
        Cookie: Astro.request.headers.get("Cookie") || "",
      },
    }
  );

  if (response.ok) {
    photosData = await response.json();
  }
} catch (error) {
  console.error("Failed to fetch photos:", error);
}
---

<Layout title="Manage Photos - Admin" showNavigation={true}>
  <div class="min-h-screen bg-neutral-50 dark:bg-neutral-950">
    <div class="container mx-auto px-4 py-8 md:py-12">
      <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
          <div>
            <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
              Manage Photos
            </h1>
            <p class="text-neutral-600 dark:text-neutral-400 mt-2">
              {photosData ? `${photosData.pagination.total_items} photos total` : "Loading..."}
            </p>
          </div>
          <a
            href="/admin/photo-moderation"
            class="inline-flex items-center justify-center rounded-md bg-neutral-900 dark:bg-neutral-100 px-4 py-2 text-sm font-medium text-white dark:text-neutral-900 shadow hover:bg-neutral-700 dark:hover:bg-neutral-300 focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:ring-offset-2 transition-colors"
          >
            Photo Moderation
          </a>
        </div>

        <!-- Photos List with Bulk Actions -->
        {
          photosData && (
            <PhotosListWithBulkActions
              client:load
              initialPhotos={photosData.photos}
            />
          )
        }
      </div>
    </div>
  </div>
</Layout>
