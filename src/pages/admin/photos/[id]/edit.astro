---
import Layout from "@/layouts/Layout.astro";
import { PhotoEditForm } from "@/components/PhotoEditForm";
import { Toaster } from "@/components/ui/sonner";
import type { AdminPhotoDTO } from "@/types";

export const prerender = false;

// Check authentication
const { user } = Astro.locals;

if (!user) {
  return Astro.redirect(`/login?redirect=${encodeURIComponent(Astro.url.pathname)}`);
}

// Check admin role
const { data: userData, error: userError } = await Astro.locals.supabase
  .from("users")
  .select("role, email")
  .eq("id", user.id)
  .single();

if (userError || !userData || userData.role !== "admin") {
  return Astro.redirect("/?error=unauthorized");
}

// Get photo ID from URL
const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/admin/photos?error=no-id");
}

// Fetch photo data
let photo: AdminPhotoDTO | null = null;
let fetchError: string | null = null;

try {
  const response = await fetch(`${Astro.url.origin}/api/admin/photos/${id}`, {
    headers: {
      Cookie: Astro.request.headers.get("Cookie") || "",
    },
  });

  if (!response.ok) {
    if (response.status === 404) {
      return Astro.redirect("/admin/photos?error=not-found");
    }
    throw new Error("Failed to fetch photo");
  }

  photo = await response.json();
} catch (error) {
  console.error("Failed to fetch photo:", error);
  fetchError = error instanceof Error ? error.message : "Failed to fetch photo";
}
---

<Layout title="Edit Photo - Admin" showNavigation={true}>
  <div class="min-h-screen bg-neutral-50 dark:bg-neutral-950">
    <div class="container mx-auto px-4 py-8 md:py-12">
      {
        fetchError || !photo ? (
          // Error View
          <div class="max-w-2xl mx-auto">
            <div class="bg-white dark:bg-neutral-900 rounded-lg shadow-lg p-8 text-center">
              <div class="mx-auto mb-6 flex h-16 w-16 items-center justify-center rounded-full bg-red-100 dark:bg-red-950">
                <svg
                  class="h-8 w-8 text-red-600 dark:text-red-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  aria-hidden="true"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                  />
                </svg>
              </div>

              <h1 class="text-2xl font-bold text-neutral-900 dark:text-neutral-100 mb-4">Failed to Load Photo</h1>

              <p class="text-neutral-600 dark:text-neutral-400 mb-6">
                {fetchError || "The photo you're trying to edit could not be found."}
              </p>

              <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <a
                  href="/admin/photos"
                  class="inline-flex items-center justify-center rounded-md bg-neutral-900 dark:bg-neutral-100 px-4 py-2 text-sm font-medium text-white dark:text-neutral-900 shadow hover:bg-neutral-700 dark:hover:bg-neutral-300 focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:ring-offset-2 transition-colors"
                >
                  Back to Photos
                </a>
              </div>
            </div>
          </div>
        ) : (
          // Edit Form
          <>
            <Toaster client:load />
            <PhotoEditForm client:load photo={photo} />
          </>
        )
      }
    </div>
  </div>
</Layout>
