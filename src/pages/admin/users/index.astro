---
import Layout from "@/layouts/Layout.astro";
import { UsersList } from "@/components/UsersList";
import type { AdminUsersResponseDTO } from "@/types";

export const prerender = false;

// Check authentication
const { user } = Astro.locals;

if (!user) {
  return Astro.redirect("/login?redirect=/admin/users");
}

// Check admin role
const { data: userData, error: userError } = await Astro.locals.supabase
  .from("users")
  .select("role")
  .eq("id", user.id)
  .single();

if (userError || !userData || userData.role !== "admin") {
  return Astro.redirect("/?error=unauthorized");
}

// Fetch users
let usersData: AdminUsersResponseDTO | null = null;
let errorMessage: string | null = null;

try {
  const response = await fetch(
    `${Astro.url.origin}/api/admin/users?page=1&limit=100`,
    {
      headers: {
        Cookie: Astro.request.headers.get("Cookie") || "",
      },
    }
  );

  if (response.ok) {
    usersData = await response.json();
  } else {
    errorMessage = "Failed to load users";
  }
} catch (error) {
  console.error("Failed to fetch users:", error);
  errorMessage = "Failed to load users";
}
---

<Layout title="Manage Users - Admin" showNavigation={true}>
  <div class="min-h-screen bg-neutral-50 dark:bg-neutral-950">
    <div class="container mx-auto px-4 py-8 md:py-12">
      <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100">
                User Management
              </h1>
              <p class="text-neutral-600 dark:text-neutral-400 mt-2">
                Manage user roles and photo submission permissions
              </p>
            </div>
            <div class="flex gap-2">
              <a
                href="/admin"
                class="inline-flex items-center justify-center rounded-md bg-neutral-100 dark:bg-neutral-800 px-4 py-2 text-sm font-medium text-neutral-900 dark:text-neutral-100 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors"
              >
                Dashboard
              </a>
              <a
                href="/admin/photo-moderation"
                class="inline-flex items-center justify-center rounded-md bg-neutral-100 dark:bg-neutral-800 px-4 py-2 text-sm font-medium text-neutral-900 dark:text-neutral-100 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors"
              >
                Photo Moderation
              </a>
              <a
                href="/admin/photos"
                class="inline-flex items-center justify-center rounded-md bg-neutral-100 dark:bg-neutral-800 px-4 py-2 text-sm font-medium text-neutral-900 dark:text-neutral-100 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors"
              >
                Manage Photos
              </a>
            </div>
          </div>

          <!-- Stats -->
          {
            usersData && (
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-4">
                  <div class="text-sm text-neutral-600 dark:text-neutral-400">Total Users</div>
                  <div class="text-2xl font-bold text-neutral-900 dark:text-neutral-100 mt-1">
                    {usersData.stats.total_users}
                  </div>
                </div>
                <div class="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-4">
                  <div class="text-sm text-neutral-600 dark:text-neutral-400">Admins</div>
                  <div class="text-2xl font-bold text-blue-600 dark:text-blue-400 mt-1">
                    {usersData.stats.total_admins}
                  </div>
                </div>
                <div class="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-4">
                  <div class="text-sm text-neutral-600 dark:text-neutral-400">Can Add Photos</div>
                  <div class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">
                    {usersData.stats.users_with_photo_permission}
                  </div>
                </div>
                <div class="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-4">
                  <div class="text-sm text-neutral-600 dark:text-neutral-400">With Consent</div>
                  <div class="text-2xl font-bold text-neutral-900 dark:text-neutral-100 mt-1">
                    {usersData.stats.users_with_consent}
                  </div>
                </div>
              </div>
            )
          }
        </div>

        <!-- Users List -->
        {
          errorMessage ? (
            <div class="bg-red-50 dark:bg-red-950 border border-red-200 dark:border-red-900 rounded-lg p-6 text-center">
              <p class="text-red-900 dark:text-red-100 font-medium">{errorMessage}</p>
            </div>
          ) : usersData ? (
            <UsersList client:load initialUsers={usersData.users} />
          ) : (
            <div class="bg-white dark:bg-neutral-900 rounded-lg border border-neutral-200 dark:border-neutral-800 p-8 text-center">
              <p class="text-neutral-500">Loading users...</p>
            </div>
          )
        }
      </div>
    </div>
  </div>
</Layout>
